<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NFC Flashcard JPD123 (Online)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Marked JS -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- FIREBASE SDK (Quan trọng) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Roboto', 'sans-serif'], jp: ['Noto Sans JP', 'sans-serif'] },
                    colors: { brand: { dark: '#0f172a', card: '#1e293b', accent: '#8b5cf6' } }
                }
            }
        }
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .perspective-1000 { perspective: 1000px; }
        .transform-style-3d { transform-style: preserve-3d; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-inner { transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .card-flip .card-inner { transform: rotateY(180deg); }
        ruby { display: inline-flex; flex-direction: column-reverse; align-items: center; vertical-align: bottom; }
        rt { font-size: 0.6em; line-height: 1; margin-bottom: 2px; text-align: center; user-select: none; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .card-image { width: 100%; max-width: 100%; object-fit: cover; border-radius: 16px; pointer-events: none; margin: 0 auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .card-image-front { height: 180px; }
        .card-image-back { width: 70%; max-width: 70%; height: 90px; border-radius: 12px; }
        .kanji-glow { text-shadow: 0 0 20px rgba(167, 139, 250, 0.8); }
        .prose { color: #cbd5e1; font-size: 0.9rem; }
        .prose strong { color: #a78bfa; font-weight: 700; }
        .prose p { margin-bottom: 0.5em; }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans min-h-screen overflow-x-hidden bg-gradient-to-br from-slate-900 via-indigo-950 to-slate-900 selection:bg-purple-500 selection:text-white">

    <div id="app" class="max-w-md mx-auto min-h-screen relative shadow-2xl bg-black/20 flex flex-col">
        
        <div id="toast" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none z-50 flex items-center gap-2 text-sm border border-white/10">
            <i class="fas fa-info-circle text-brand-accent"></i><span id="toast-msg">Thông báo</span>
        </div>

        <!-- LOGIN -->
        <section id="screen-login" class="p-6 flex flex-col justify-center min-h-screen hidden">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-gradient-to-tr from-purple-500 to-pink-500 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-purple-500/30"><span class="text-4xl font-bold text-white">JP</span></div>
                <h1 class="text-3xl font-bold mb-2">JPD123 Online</h1>
                <p class="text-slate-400 text-sm">Học tiếng Nhật (Server Realtime)</p>
            </div>
            <form id="login-form" class="space-y-4">
                <div><label class="text-xs text-slate-400 uppercase">Họ và tên</label><input type="text" id="login-name" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 focus:border-purple-500 outline-none" required></div>
                <div><label class="text-xs text-slate-400 uppercase">Email FPT</label><input type="email" id="login-email" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 focus:border-purple-500 outline-none" required></div>
                <div id="class-input-group" class="hidden"><label class="text-xs text-slate-400 uppercase">Mã lớp</label><input type="text" id="login-class" class="w-full bg-slate-800 border border-slate-700 rounded-xl px-4 py-3 focus:border-purple-500 outline-none"></div>
                <button type="submit" class="w-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold py-3 rounded-xl mt-6 flex justify-center items-center gap-2">
                    <span>Đăng Nhập</span> <i id="login-spinner" class="fas fa-spinner fa-spin hidden"></i>
                </button>
            </form>
        </section>

        <!-- DASHBOARD -->
        <section id="screen-dashboard" class="hidden min-h-screen pb-20">
            <header class="p-6 pb-2 flex justify-between items-center">
                <div>
                    <h2 class="text-xl font-bold">Xin chào, <span id="user-display-name" class="text-purple-400"></span></h2>
                    <p class="text-xs text-slate-400" id="user-role-display">Học sinh</p>
                </div>
                <button onclick="logout()" class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center hover:bg-slate-700 border border-slate-700">
                    <i class="fas fa-sign-out-alt text-slate-400"></i>
                </button>
            </header>
            
            <div class="px-6 pb-2">
                <div class="flex items-center gap-2 text-xs text-green-400" id="connection-status">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-green-500"></span>
                    </span>
                    Đang kết nối Server...
                </div>
            </div>

            <div class="p-6">
                <h3 class="text-sm uppercase font-bold text-slate-500 mb-4">Chọn bài học</h3>
                <div class="grid grid-cols-2 gap-4" id="lesson-grid"></div>
                
                <div id="teacher-dashboard-controls" class="hidden mt-8 space-y-3">
                    <h3 class="text-sm uppercase font-bold text-slate-500 mb-4">Quản lý</h3>
                    <button onclick="app.navigateTo('teacher-progress')" class="w-full bg-slate-800 p-4 rounded-xl border border-slate-700 flex items-center justify-between hover:bg-slate-750">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-blue-500/20 text-blue-400 flex items-center justify-center">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            <div class="text-left">
                                <div class="font-bold text-sm">Tiến độ học sinh</div>
                                <div class="text-xs text-slate-400">Theo dõi Realtime</div>
                            </div>
                        </div>
                        <i class="fas fa-chevron-right text-slate-600"></i>
                    </button>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="dataMgr.exportData()" class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col items-center hover:bg-slate-700">
                            <i class="fas fa-download text-green-400 mb-1 text-lg"></i><span class="text-xs font-bold">Backup JSON</span>
                        </button>
                        <button onclick="document.getElementById('inp-import-file').click()" class="bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col items-center hover:bg-slate-700">
                            <i class="fas fa-cloud-upload-alt text-yellow-400 mb-1 text-lg"></i><span class="text-xs font-bold">Upload JSON</span>
                        </button>
                        <input type="file" id="inp-import-file" accept=".json" class="hidden" onchange="dataMgr.importData(this)">
                    </div>
                </div>
                
                 <div id="student-dashboard-summary" class="hidden mt-8">
                    <h3 class="text-sm uppercase font-bold text-slate-500 mb-4">Tiến độ</h3>
                    <div class="glass p-4 rounded-xl">
                        <div class="flex justify-between text-sm mb-2">
                            <span class="text-slate-300">Đã thuộc</span>
                            <span class="text-green-400 font-bold" id="dash-mastered-count">0</span>
                        </div>
                         <div class="w-full bg-slate-700 rounded-full h-2.5 mb-4">
                            <div id="dash-progress-bar" class="bg-gradient-to-r from-green-400 to-emerald-500 h-2.5 rounded-full" style="width: 0%"></div>
                         </div>
                         <div class="grid grid-cols-3 gap-2 text-center text-xs">
                            <div class="bg-slate-800/50 p-2 rounded-lg">
                                <div class="text-blue-400 font-bold text-lg" id="dash-learning">0</div>
                                <div>Đang học</div>
                            </div>
                            <div class="bg-slate-800/50 p-2 rounded-lg">
                                <div class="text-orange-400 font-bold text-lg" id="dash-review">0</div>
                                <div>Cần ôn</div>
                            </div>
                            <div class="bg-slate-800/50 p-2 rounded-lg">
                                <div class="text-green-400 font-bold text-lg" id="dash-done">0</div>
                                <div>Thuộc</div>
                            </div>
                        </div>
                </div>
            </div>
        </section>

        <!-- TEACHER MANAGER -->
        <section id="screen-teacher-manager" class="hidden min-h-screen pb-20 bg-slate-900">
            <header class="sticky top-0 z-30 bg-slate-900/90 backdrop-blur border-b border-slate-800 p-4 flex items-center justify-between">
                <button onclick="app.navigateTo('dashboard')" class="text-slate-400 hover:text-white"><i class="fas fa-arrow-left mr-2"></i>Quay lại</button>
                <h2 class="font-bold text-lg">Bài <span id="mgr-lesson-num"></span></h2>
                <button onclick="teacherMgr.showAddModal()" class="w-8 h-8 bg-purple-600 rounded-full flex items-center justify-center text-white shadow-lg hover:bg-purple-500"><i class="fas fa-plus"></i></button>
            </header>
            <div class="p-4">
                <div id="teacher-word-list" class="space-y-3"></div>
            </div>
        </section>

        <!-- TEACHER PROGRESS -->
        <section id="screen-teacher-progress" class="hidden min-h-screen bg-slate-900">
            <header class="sticky top-0 z-30 bg-slate-900/90 backdrop-blur border-b border-slate-800 p-4 flex items-center justify-between">
                <button onclick="app.navigateTo('dashboard')" class="text-slate-400 hover:text-white">
                    <i class="fas fa-arrow-left mr-2"></i>Quay lại
                </button>
                <h2 class="font-bold text-lg">Tiến độ (Online)</h2>

                <div class="relative">
                    <button onclick="document.getElementById('menu-progress-actions').classList.toggle('hidden')" class="text-slate-400 hover:text-white p-2">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div id="menu-progress-actions" class="hidden absolute right-0 mt-2 bg-slate-800 border border-slate-700 rounded-lg shadow-xl w-52 text-xs z-50">
                        <button onclick="teacherStats.confirmResetClass(); document.getElementById('menu-progress-actions').classList.add('hidden');" class="w-full text-left px-3 py-2 text-yellow-300 hover:bg-slate-700 border-b border-slate-700">
                            Xóa tiến độ lớp đang chọn
                        </button>
                        <button onclick="teacherStats.confirmResetAll(); document.getElementById('menu-progress-actions').classList.add('hidden');" class="w-full text-left px-3 py-2 text-red-300 hover:bg-red-900/40">
                            Xóa TOÀN BỘ tiến độ Server
                        </button>
                    </div>
                </div>
            </header>
            <div class="p-4">
                <div class="mb-4">
                    <label class="text-xs text-slate-500 uppercase font-bold block mb-1">Chọn lớp</label>
                    <select id="teacher-class-select" onchange="teacherStats.loadStudents()" class="w-full bg-slate-800 text-white border border-slate-700 rounded-lg p-2 outline-none text-sm">
                        <option value="">(Tất cả)</option>
                    </select>
                </div>
                <div id="student-list-container" class="space-y-3"></div>
            </div>
        </section>

        <!-- STUDENT STUDY -->
        <section id="screen-student-study" class="hidden h-screen flex flex-col bg-slate-900">
            <header class="p-4 flex justify-between items-center bg-slate-900 z-10 shrink-0">
                <button onclick="app.navigateTo('dashboard')" class="w-8 h-8 flex items-center justify-center text-slate-400"><i class="fas fa-times text-xl"></i></button>
                <div class="font-mono text-sm text-slate-400"><span id="fc-current-index">1</span> / <span id="fc-total">20</span></div>
                <button onclick="studentStudy.toggleShuffle()" id="btn-shuffle" class="text-slate-400 hover:text-purple-400 transition-colors"><i class="fas fa-random"></i></button>
            </header>
            <div class="w-full bg-slate-800 h-1 shrink-0"><div id="fc-progress-bar" class="bg-purple-500 h-1 transition-all duration-300" style="width: 0%"></div></div>
            <div class="flex-1 flex flex-col items-center justify-center p-4 relative overflow-hidden">
                <div class="perspective-1000 w-full h-full max-h-[550px] cursor-pointer group relative" onclick="studentStudy.flipCard()">
                    <div id="flashcard-inner" class="card-inner w-full h-full relative transform-style-3d shadow-2xl shadow-black/50 rounded-3xl">
                        <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 rounded-3xl z-20 overflow-hidden flex flex-col justify-between">
                            <div class="flex justify-between p-4 shrink-0 relative z-30">
                                <div onclick="event.stopPropagation(); studentStudy.playAudio()" class="p-2 bg-black/20 hover:bg-white/10 rounded-full transition-colors"><i class="fas fa-volume-up text-slate-300 text-xl"></i></div>
                                <div onclick="event.stopPropagation(); studentStudy.toggleFav()" class="p-2 bg-black/20 hover:bg:white/10 rounded-full transition-colors"><i id="fc-star" class="far fa-star text-yellow-500 text-xl transition-transform active:scale-125"></i></div>
                            </div>
                            <div class="flex-1 flex flex-col items-center justify-start w-full px-4 pt-4 relative z-20">
                                <div id="fc-image-container-front" class="hidden mb-6 w-full px-6 flex justify-center" style="min-height: 0;">
                                     <img id="fc-image-front" src="" alt="Minh họa" class="card-image card-image-front">
                                </div>
                                <div class="w-full text-center shrink-0">
                                    <h1 id="fc-kanji-front" class="kanji-glow text-5xl md:text-7xl font-jp font-bold text-white tracking-wide leading-tight break-words relative z-50 drop-shadow-lg"></h1>
                                </div>
                            </div>
                            <div class="h-10 w-full flex items-center justify-center text-xs text-purple-300 uppercase tracking-widest font-bold animate-pulse shrink-0 bg-black/10 z-30">
                                <span><i class="fas fa-hand-pointer mr-1"></i> Chạm để lật</span>
                            </div>
                        </div>
                        <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 rounded-3xl p-4 flex flex-col z-10 overflow-hidden">
                             <div class="text-center mb-2 pb-2 border-b border-slate-700/50 mt-2 overflow-y-auto shrink-0" style="max-height: 45%;">
                                 <div id="fc-image-container-back" class="hidden w-full flex justify-center items-center mb-2">
                                     <img id="fc-image-back" src="" alt="Minh họa" class="card-image card-image-back">
                                 </div>
                                <div id="fc-kanji-back" class="text-3xl font-jp font-bold mb-1 text-white"></div>
                                <h2 id="fc-meaning-vi" class="text-lg font-bold text-purple-300 mb-0 mt-1"></h2>
                                <p id="fc-romaji" class="text-xs text-slate-500 font-mono"></p>
                             </div>
                             <div class="flex-1 space-y-2 overflow-y-auto pr-1 pb-14 scrollbar-hide" id="fc-examples"></div>
                             <div class="absolute bottom-4 left-0 w-full flex justify-center px-4" onclick="event.stopPropagation()">
                                <button onclick="geminiService.explainWord()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-500 hover:to-purple-500 text:white text-sm font-bold py-2 px-4 rounded-xl shadow-lg flex items-center justify-center gap-2 border border-white/10 transform active:scale-95 transition-all">
                                    <i class="fas fa-sparkles text-yellow-300"></i> AI Giải thích
                                </button>
                             </div>
                        </div>
                    </div>
                </div>
                <div class="w-full mt-6 grid grid-cols-5 gap-2 max-w-sm mx-auto shrink-0">
                    <button onclick="studentStudy.prevCard()" class="bg-slate-800 h-12 rounded-full text-slate-400 hover:bg-slate-700"><i class="fas fa-undo"></i></button>
                    <button onclick="studentStudy.markStatus('review')" class="col-span-2 bg-slate-800 h-12 rounded-full text-orange-400 font-bold border border-orange-500/30 hover:bg-orange-500/10 text-xs sm:text-sm"><i class="fas fa-sync-alt mr-1"></i>Ôn lại</button>
                    <button onclick="studentStudy.markStatus('mastered')" class="bg-green-600 h-12 rounded-full text-white shadow-lg hover:bg-green-500"><i class="fas fa-check"></i></button>
                    <button onclick="studentStudy.nextCard()" class="bg-slate-800 h-12 rounded-full text-purple-400 hover:bg-slate-700"><i class="fas fa-chevron-right"></i></button>
                </div>
            </div>
        </section>

        <!-- MODALS -->
        <div id="modal-ai" class="fixed inset-0 bg-black/90 backdrop-blur-md hidden z-50 flex items-center justify-center p-4">
            <div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 shadow-2xl flex flex-col max-h-[80vh]">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center bg-gradient-to-r from-indigo-900/50 to-purple-900/50 rounded-t-2xl"><h3 class="font-bold text-lg text:white"><i class="fas fa-robot text-purple-400 mr-2"></i>AI Trợ lý</h3><button onclick="geminiService.closeModal()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button></div>
                <div class="p-6 overflow-y-auto flex-1 leading-relaxed space-y-2" id="ai-content"></div>
                <div class="p-4 border-t border-slate-800 text-center"><button onclick="geminiService.closeModal()" class="bg-slate-800 text-white px-6 py-2 rounded-xl hover:bg-slate-700 w-full">Đóng</button></div>
            </div>
        </div>

        <div id="modal-word" class="fixed inset-0 bg-black/80 backdrop-blur-sm hidden z-50 flex items-end sm:items-center justify-center p-0 sm:p-4">
             <div class="bg-slate-900 w-full max-w-lg rounded-t-2xl sm:rounded-2xl border border-slate-700 max-h:[90vh] flex flex-col">
                <div class="p-4 border-b border-slate-800 flex justify-between items-center"><h3 class="font-bold text-lg">Thông tin từ vựng</h3><button onclick="teacherMgr.closeModal()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button></div>
                <div class="p-4 overflow-y-auto space-y-4 flex-1">
                    <input type="hidden" id="word-mode">
                    <div><label class="text-xs text-slate-500 block mb-1">ID (URL/NFC)</label><input type="text" id="inp-id" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm font-mono text-yellow-400"></div>
                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs text-slate-500 block mb-1">Kanji</label><input type="text" id="inp-kanji" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"></div>
                        <div><label class="text-xs text-slate-500 block mb-1">Hiragana</label><input type="text" id="inp-furigana" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"></div>
                        <div><label class="text-xs text-slate-500 block mb-1">Romaji</label><input type="text" id="inp-romaji" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"></div>
                        <div><label class="text-xs text-slate-500 block mb-1">Nghĩa Việt</label><input type="text" id="inp-vi" class="w-full bg-slate-800 border border-slate-700 rounded px-3 py-2 text-sm"></div>
                    </div>
                    
                    <div class="border border-slate-700 p-3 rounded bg-slate-800/50">
                        <label class="text-xs text-slate-400 block mb-2 font-bold uppercase">Hình ảnh minh họa</label>
                        <input type="file" id="inp-image-file" accept="image/*" class="block w-full text-xs text-slate-400 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-purple-600 file:text-white hover:file:bg-purple-700 cursor-pointer"/>
                        <div id="preview-image-container" class="mt-2 hidden">
                            <img id="preview-image" src="" class="h-20 rounded object-contain border border-slate-600">
                        </div>
                        <input type="hidden" id="inp-image-base64">
                    </div>

                    <div class="border-t border-slate-800 pt-3">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs text-slate-500 font-bold">5 Câu Ví dụ</label>
                            <button type="button" onclick="geminiService.generateExamples()" class="sparkle-btn bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-500 hover:to-orange-500 text-white text-xs px-2 py-1 rounded shadow flex items-center gap-1">
                                <i class="fas fa-magic"></i> AI Tạo Ví Dụ
                            </button>
                        </div>
                        <div id="example-inputs-container" class="space-y-3"></div>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-800 grid grid-cols-2 gap-4">
                    <button onclick="teacherMgr.closeModal()" class="py-2 text-slate-400 hover:text-white">Hủy</button>
                    <button onclick="teacherMgr.saveWord()" class="py-2 bg-purple-600 rounded-lg text-white font-bold">Lưu</button>
                </div>
             </div>
        </div>
    </div>

    <!-- MAIN APP SCRIPT -->
    <script>
        // --- 1. CẤU HÌNH FIREBASE (Dữ liệu của bạn) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtlslkylHhhhQCSL9fwxBK5QQpXwqp8rw",
            authDomain: "jpd123-flashcard.firebaseapp.com",
            databaseURL: "https://jpd123-flashcard-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "jpd123-flashcard",
            storageBucket: "jpd123-flashcard.firebasestorage.app",
            messagingSenderId: "1085810162442",
            appId: "1:1085810162442:web:c69c3bd93a219fa2a118f3"
        };
        // ----------------------------------------------------

        // Khởi động kết nối
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const dbRef = firebase.database().ref();

        let userApiKey = "";
        const apiKey = ""; 
        const TEACHER_DOMAINS = ['@fe.edu.vn', '@fpt.com.vn'];
        const SPECIAL_TEACHERS = ['anhbpsa180223@fpt.edu.vn', 'oanhvttsa170012@fpt.edu.vn', 'thuthasa180107@fpt.edu.vn'];
        const STUDENT_DOMAIN = '@fpt.edu.vn';
        const LESSONS = [4, 5, 6, 7];

        // Fallback data
        window.SEED_DATA = [
            { id: 'hon', lesson: 4, kanji: '本', furigana: 'ほん', romaji: 'hon', vi: 'Sách', image: '', examples: [{jp: 'これは本です', vi: 'Đây là quyển sách'}] },
            { id: 'tegami', lesson: 5, kanji: '手紙', furigana: 'てがみ', romaji: 'tegami', vi: 'Bức thư', image: '', examples: [{jp: '手紙を書きます', vi: 'Tôi viết thư'}] },
        ];

        window.db = { words: [], progress: {} };
        window.session = { user: null, currentLesson: null, nfcTarget: null, studyList: [], currentIndex: 0, isShuffle: false };
        window.__progressDocs = []; 

        const $ = id => document.getElementById(id);
        const showScreen = (id) => {
            document.querySelectorAll('section[id^="screen-"]').forEach(el => el.classList.add('hidden'));
            $(id).classList.remove('hidden');
        };
        const showToast = (msg) => {
            const t = $('toast'); $('toast-msg').innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 2000);
        };
        const speakJP = (text) => {
            if(!text) return;
            const u = new SpeechSynthesisUtterance(text.replace(/<[^>]*>/g, ''));
            u.lang = 'ja-JP';
            window.speechSynthesis.speak(u);
        };
        const generateRubyHtml = (k, f) => (!f || k === f) ? k : `<ruby>${k}<rt>${f}</rt></ruby>`;

        window.logout = () => {
            localStorage.removeItem('jpd123_user');
            window.session.user = null;
            location.reload();
        };

        const compressImage = (file, callback) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    const MAX_SIZE = 800;
                    let width = img.width;
                    let height = img.height;
                    if (width > height) { if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } } 
                    else { if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } }
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7);
                    callback(dataUrl);
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        };

        const handleImageUpload = (input) => {
            const file = input.files[0]; if (!file) return;
            compressImage(file, (base64) => {
                $('inp-image-base64').value = base64;
                $('preview-image').src = base64;
                $('preview-image-container').classList.remove('hidden');
                if(base64.length > 800000) showToast("Ảnh lớn, tải lên sẽ hơi lâu...");
            });
        };

        const dataMgr = {
            exportData: () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(window.db.words));
                const el = document.createElement('a'); el.setAttribute("href", dataStr); el.setAttribute("download", "jpd123_data.json");
                document.body.appendChild(el); el.click(); el.remove(); showToast("Đã xuất file backup!");
            },
            importData: (input) => {
                const file = input.files[0]; if (!file) return;
                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const newWords = JSON.parse(e.target.result);
                        if (confirm(`Tìm thấy ${newWords.length} từ. Ghi đè lên Server?`)) {
                            for(const w of newWords) { await dbRef.child('words/' + w.id).set(w); }
                            alert("Đã nhập xong dữ liệu lên mạng!");
                        }
                    } catch (err) { alert("Lỗi file JSON!"); }
                };
                reader.readAsText(file); input.value = '';
            }
        };
        window.dataMgr = dataMgr;

        const geminiService = {
            getKey: () => {
                if (apiKey) return apiKey; if (userApiKey) return userApiKey;
                const i = prompt("Nhập API Key Gemini (nếu có):");
                if (i && i.trim()) { userApiKey = i.trim(); return userApiKey; } return null;
            },
            explainWord: async () => {
                const key = geminiService.getKey(); if (!key) { alert("Chưa có Key AI."); return; }
                const w = window.session.studyList[window.session.currentIndex];
                $('modal-ai').classList.remove('hidden');
                $('ai-content').innerHTML = `<div class="flex flex-col items-center justify-center h-40"><div class="w-10 h-10 border-4 border-purple-500 border-t-transparent rounded-full animate-spin"></div><p class="text-purple-300 mt-2">AI đang suy nghĩ...</p></div>`;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Giải thích từ Nhật: "${w.kanji}" (${w.furigana} - ${w.vi}). 1. Ý nghĩa. 2. Cách dùng. 3. Mẹo nhớ. Markdown.` }] }] })
                    });
                    const data = await res.json();
                    const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "Lỗi AI.";
                    $('ai-content').innerHTML = `<div class="prose prose-invert prose-sm">${marked.parse(text)}</div>`;
                } catch (e) { $('ai-content').innerHTML = `Lỗi: ${e.message}`; }
            },
            generateExamples: async () => {
                const key = geminiService.getKey(); if (!key) return alert("Chưa có Key AI.");
                const k = $('inp-kanji').value; const m = $('inp-vi').value;
                if(!k) return alert("Nhập Kanji đã!");
                const btn = document.querySelector('.sparkle-btn'); btn.disabled = true;
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ contents: [{ parts: [{ text: `Generate 5 simple JP sentences for "${k}" (${m}). JSON array: [{"jp":"...", "vi":"..."}]` }] }], generationConfig: { responseMimeType: "application/json" } })
                    });
                    const data = await res.json();
                    const json = JSON.parse(data.candidates?.[0]?.content?.parts?.[0]?.text || "[]");
                    json.forEach((ex, i) => { if(i<5) { $(`inp-ex-jp-${i}`).value = ex.jp||''; $(`inp-ex-vi-${i}`).value = ex.vi||''; } });
                } catch (e) { alert("Lỗi AI: " + e.message); } finally { btn.disabled = false; }
            },
            closeModal: () => $('modal-ai').classList.add('hidden')
        };

        // --- 2. LOGIC ĐỒNG BỘ ONLINE ---
        window.loadData = () => {
            $('connection-status').innerHTML = '<span class="animate-pulse text-green-400">●</span> Online Mode';
            
            // Lắng nghe từ vựng
            dbRef.child('words').on('value', (snapshot) => {
                const data = snapshot.val();
                window.db.words = data ? Object.values(data) : [];
                if(window.db.words.length === 0) window.db.words = [...window.SEED_DATA];
                if (window.handleVocabUpdate) window.handleVocabUpdate();
            });

            // Lắng nghe tiến độ tất cả (cho GV)
            dbRef.child('progress_all').on('value', (snapshot) => {
                const data = snapshot.val();
                window.__progressDocs = data ? Object.values(data) : [];
                if (window.handleProgressUpdate) window.handleProgressUpdate(window.__progressDocs);
            });

            // Lắng nghe tiến độ cá nhân (cho HS)
            const u = localStorage.getItem('jpd123_user');
            if(u) {
                const user = JSON.parse(u);
                const safeEmail = user.email.replace(/\./g, ',');
                dbRef.child('progress_detail/' + safeEmail).on('value', (snapshot) => {
                    window.db.progress = {[user.email]: snapshot.val() || {}};
                    if (window.session.user?.role === 'student') app.renderStudentDashboardStats();
                });
            }
        };

        // Ghi đè hàm lưu (chỉ lưu Cloud)
        window.saveData = () => {};
        window.saveProgress = () => {};

        window.cloud = {
            saveWord: async (word) => {
                try { await dbRef.child('words/' + word.id).set(word); return true; } 
                catch (e) { alert("Lỗi lưu mạng: " + e.message); return false; }
            },
            deleteWord: async (id) => {
                try { await dbRef.child('words/' + id).remove(); return true; } 
                catch (e) { alert("Lỗi xóa mạng: " + e.message); return false; }
            }
        };

        window.progressCloud = {
            saveStudentProgress: async (student) => {
                const safeEmail = student.email.replace(/\./g, ',');
                await dbRef.child('progress_all/' + safeEmail).set(student);
                await dbRef.child('progress_detail/' + safeEmail).set(student.progress);
                return true;
            }
        };

        // --- 3. UI LOGIC ---
        const app = {
            init: () => {
                window.loadData();
                const p = new URLSearchParams(location.search);
                if(p.get('lesson') && p.get('id'))
                    window.session.nfcTarget = { lesson: parseInt(p.get('lesson')), id: p.get('id') };
                const u = localStorage.getItem('jpd123_user');
                if(u) {
                    window.session.user = JSON.parse(u);
                    app.checkRedirect();
                } else {
                    showScreen('screen-login');
                    $('login-email').oninput = (e) => {
                        const val = e.target.value;
                        const isTeacher = SPECIAL_TEACHERS.includes(val) || TEACHER_DOMAINS.some(d => val.endsWith(d));
                        $('class-input-group').classList.toggle('hidden', isTeacher);
                    };
                }
                $('login-form').onsubmit = (e) => {
                    e.preventDefault();
                    $('login-spinner').classList.remove('hidden');
                    setTimeout(() => {
                        const eVal = $('login-email').value.toLowerCase();
                        const role = (SPECIAL_TEACHERS.includes(eVal) || TEACHER_DOMAINS.some(d => eVal.endsWith(d))) ? 'teacher' : (eVal.endsWith(STUDENT_DOMAIN) ? 'student' : null);
                        if(!role) { $('login-spinner').classList.add('hidden'); return alert("Email không hợp lệ!"); }
                        window.session.user = { name: $('login-name').value, email: eVal, role, className: $('login-class').value || '' };
                        localStorage.setItem('jpd123_user', JSON.stringify(window.session.user));
                        app.checkRedirect();
                    }, 400);
                };
                $('example-inputs-container').innerHTML = Array(5).fill(0).map((_, i) => `<div class="bg-slate-800/50 p-2 rounded border border-slate-700/50 flex gap-2"><input id="inp-ex-jp-${i}" class="w-1/2 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs" placeholder="Câu Nhật"><input id="inp-ex-vi-${i}" class="w-1/2 bg-slate-800 border border-slate-700 rounded px-2 py-1 text-xs" placeholder="Nghĩa Việt"></div>`).join('');
                $('inp-image-file').addEventListener('change', function() { handleImageUpload(this); });
            },
            checkRedirect: () => {
                if(window.session.nfcTarget) {
                    if(window.db.words.length === 0) { setTimeout(app.checkRedirect, 500); return; }
                    const w = window.db.words.find(x => x.id === window.session.nfcTarget.id && x.lesson === window.session.nfcTarget.lesson);
                    if(w) { app.selectLesson(window.session.nfcTarget.lesson, window.session.nfcTarget.id); window.session.nfcTarget = null; return; }
                }
                app.initDashboard();
            },
            initDashboard: () => {
                $('user-display-name').innerText = window.session.user.name;
                $('user-role-display').innerText = window.session.user.role === 'teacher' ? 'Giáo viên (Online)' : `Học sinh - ${window.session.user.className || 'N/A'}`;
                $('lesson-grid').innerHTML = LESSONS.map(n => `<div onclick="app.selectLesson(${n})" class="bg-slate-800 border border-slate-700 p-4 rounded-2xl flex flex-col items-center justify-center aspect-square hover:bg-slate-700 cursor-pointer active:scale-95"><div class="w-12 h-12 rounded-full bg-gradient-to-tr from-indigo-500 to-purple-500 flex items-center justify-center text-xl font-bold shadow-lg mb-2">${n}</div><span class="font-bold text-slate-300">Bài ${n}</span></div>`).join('');
                if(window.session.user.role === 'teacher') {
                    $('teacher-dashboard-controls').classList.remove('hidden');
                    $('student-dashboard-summary').classList.add('hidden');
                } else {
                    $('teacher-dashboard-controls').classList.add('hidden');
                    $('student-dashboard-summary').classList.remove('hidden');
                    app.renderStudentDashboardStats();
                }
                showScreen('screen-dashboard');
            },
            renderStudentDashboardStats: () => {
                let s = { l: 0, r: 0, m: 0 };
                const email = window.session.user.email;
                if(window.db.progress[email]) {
                    Object.values(window.db.progress[email]).forEach(i => {
                        if(i.status === 'mastered') s.m++; else if(i.status === 'review') s.r++; else s.l++;
                    });
                }
                $('dash-learning').innerText = s.l; $('dash-review').innerText = s.r; $('dash-done').innerText = s.m;
                const totalWords = window.db.words.length || 1;
                $('dash-mastered-count').innerText = `${s.m}/${totalWords}`;
                $('dash-progress-bar').style.width = `${(s.m / totalWords) * 100}%`;
            },
            selectLesson: (n, tid) => {
                window.session.currentLesson = n;
                const w = window.db.words.filter(x => x.lesson === n);
                if(window.session.user.role === 'teacher') {
                    teacherMgr.init(n, w); showScreen('screen-teacher-manager');
                } else {
                    if(!w.length) return showToast("Bài này chưa có từ vựng!");
                    studentStudy.init(w, tid); showScreen('screen-student-study');
                }
            },
            navigateTo: (s) => {
                if (s === 'dashboard') app.initDashboard();
                else if (s === 'teacher-progress') { showScreen('screen-teacher-progress'); if (window.teacherStats) window.teacherStats.init(); }
                else showScreen('screen-' + s);
            }
        };

        const teacherMgr = {
            currentWords: [],
            init: (l, w) => { teacherMgr.currentWords = w; $('mgr-lesson-num').innerText = l; teacherMgr.renderList(); },
            renderList: () => {
                const listEl = $('teacher-word-list');
                const baseUrl = location.origin + location.pathname;
                listEl.innerHTML = teacherMgr.currentWords.map(w => {
                    const link = `${baseUrl}?lesson=${w.lesson}&id=${w.id}`;
                    return `<div class="bg-slate-800/50 border border-slate-700 rounded-xl p-3 flex justify-between items-center"><div class="flex items-center gap-3">${w.image ? `<img src="${w.image}" class="w-10 h-10 rounded object-cover bg-slate-900">` : '<div class="w-10 h-10 rounded bg-slate-700 flex items-center justify-center text-xs text-slate-500">No img</div>'}<div><div class="font-bold text-lg font-jp">${w.kanji}</div><div class="text-xs text-slate-400">${w.vi}</div></div></div><div class="flex gap-2"><button onclick="teacherMgr.copyLink('${link}')" class="w-8 h-8 rounded-full bg-slate-700 flex items-center justify-center"><i class="fas fa-link text-xs"></i></button><button onclick="teacherMgr.editWord('${w.id}')" class="w-8 h-8 rounded-full bg-blue-900/50 text-blue-400 flex items:center justify-center"><i class="fas fa-pen text-xs"></i></button><button onclick="teacherMgr.deleteWord('${w.id}')" class="w-8 h-8 rounded-full bg-red-900/50 text-red-400 flex items-center justify-center"><i class="fas fa-trash text-xs"></i></button></div></div>`;
                }).join('');
            },
            copyLink: (u) => { if(navigator.clipboard) navigator.clipboard.writeText(u).then(()=>showToast("Đã copy link!")).catch(()=>prompt("Copy:", u)); else prompt("Copy:", u); },
            showAddModal: () => {
                $('word-mode').value = 'add'; $('inp-id').value = ''; $('inp-id').disabled = false;
                ['inp-kanji','inp-furigana','inp-romaji','inp-vi','inp-image-base64'].forEach(id => $(id).value = '');
                $('inp-image-file').value = ''; $('preview-image-container').classList.add('hidden');
                for(let i=0; i<5; i++) { $(`inp-ex-jp-${i}`).value = ''; $(`inp-ex-vi-${i}`).value = ''; }
                $('modal-word').classList.remove('hidden');
            },
            editWord: (id) => {
                const w = window.db.words.find(i => i.id === id && i.lesson === window.session.currentLesson); if(!w) return;
                $('word-mode').value = 'edit'; $('inp-id').value = w.id; $('inp-id').disabled = true;
                $('inp-kanji').value = w.kanji; $('inp-furigana').value = w.furigana; $('inp-romaji').value = w.romaji; $('inp-vi').value = w.vi; $('inp-image-base64').value = w.image || '';
                if(w.image) { $('preview-image').src = w.image; $('preview-image-container').classList.remove('hidden'); } else $('preview-image-container').classList.add('hidden');
                for(let i=0; i<5; i++) { $(`inp-ex-jp-${i}`).value = w.examples[i]?.jp || ''; $(`inp-ex-vi-${i}`).value = w.examples[i]?.vi || ''; }
                $('modal-word').classList.remove('hidden');
            },
            saveWord: async () => {
                const id = $('inp-id').value.trim(); if(!id) return alert("Thiếu ID!");
                const nw = { id, lesson: Number(window.session.currentLesson), kanji: $('inp-kanji').value, furigana: $('inp-furigana').value, romaji: $('inp-romaji').value, vi: $('inp-vi').value, image: $('inp-image-base64').value, examples: [] };
                for(let i=0; i<5; i++) { const j = $(`inp-ex-jp-${i}`).value; const v = $(`inp-ex-vi-${i}`).value; if(j && v) nw.examples.push({jp: j, vi: v}); }
                showToast("Đang lưu lên server...");
                const success = await window.cloud.saveWord(nw);
                if(success) { showToast("Đã lưu!"); teacherMgr.closeModal(); }
            },
            closeModal: () => $('modal-word').classList.add('hidden'),
            deleteWord: async (id) => { if(confirm("Xóa từ này khỏi Server?")) await window.cloud.deleteWord(id); }
        };

        const studentStudy = {
            init: (w, tid) => {
                window.session.studyList = [...w];
                window.session.currentIndex = tid ? Math.max(0, window.session.studyList.findIndex(x => x.id === tid)) : 0;
                studentStudy.render();
            },
            render: () => {
                const w = window.session.studyList[window.session.currentIndex]; if(!w) return;
                $('fc-current-index').innerText = window.session.currentIndex + 1; $('fc-total').innerText = window.session.studyList.length;
                $('fc-progress-bar').style.width = `${((window.session.currentIndex + 1) / window.session.studyList.length) * 100}%`;
                $('flashcard-inner').parentElement.classList.remove('card-flip');
                $('fc-kanji-front').innerText = w.kanji;
                if(w.image) { $('fc-image-front').src = w.image; $('fc-image-container-front').classList.remove('hidden'); } else $('fc-image-container-front').classList.add('hidden');
                $('fc-kanji-back').innerHTML = generateRubyHtml(w.kanji, w.furigana);
                $('fc-meaning-vi').innerText = w.vi; $('fc-romaji').innerText = w.romaji || '';
                if(w.image) { $('fc-image-back').src = w.image; $('fc-image-container-back').classList.remove('hidden'); } else $('fc-image-container-back').classList.add('hidden');
                $('fc-examples').innerHTML = (w.examples || []).map(e => `<div class="bg-black/20 p-2 rounded-lg border border-white/5"><div class="flex justify-between mb-1"><span class="text-blue-300 font-jp">${e.jp}</span><i onclick="event.stopPropagation(); speakJP('${e.jp}')" class="fas fa-volume-up text-slate-500 cursor-pointer"></i></div><div class="text-xs text-slate-300">${e.vi}</div></div>`).join('');
                setTimeout(() => speakJP(w.kanji), 500);
            },
            flipCard: () => { const c = $('flashcard-inner').parentElement; c.classList.toggle('card-flip'); if(c.classList.contains('card-flip')) speakJP(window.session.studyList[window.session.currentIndex].kanji); },
            prevCard: () => { if(window.session.currentIndex > 0) { window.session.currentIndex--; studentStudy.render(); } },
            nextCard: () => { if(window.session.currentIndex < window.session.studyList.length - 1) { window.session.currentIndex++; studentStudy.render(); } else showToast("Đã hết thẻ!"); },
            markStatus: (s) => { 
                const w = window.session.studyList[window.session.currentIndex];
                const email = window.session.user.email;
                if (!window.db.progress[email]) window.db.progress[email] = {};
                window.db.progress[email][w.id] = { status: s, lastReviewed: Date.now() };
                window.progressCloud.saveStudentProgress({ email: window.session.user.email, name: window.session.user.name, className: window.session.user.className || '', progress: window.db.progress[email] });
                showToast("Đã lưu tiến độ!");
                setTimeout(() => { if(window.session.currentIndex < window.session.studyList.length - 1) { window.session.currentIndex++; studentStudy.render(); } }, 300); 
            },
            toggleShuffle: () => {
                window.session.isShuffle = !window.session.isShuffle; $('btn-shuffle').classList.toggle('text-purple-400', window.session.isShuffle);
                if(window.session.isShuffle) window.session.studyList.sort(() => Math.random() - 0.5); else window.session.studyList = window.db.words.filter(w => w.lesson === window.session.currentLesson);
                window.session.currentIndex = 0; studentStudy.render();
            },
            playAudio: () => speakJP(window.session.studyList[window.session.currentIndex].kanji),
            toggleFav: () => { const i = $('fc-star'); i.classList.toggle('fas'); i.classList.toggle('far'); }
        };

        window.handleVocabUpdate = () => {
            if (window.session.user?.role === 'teacher') {
                const scrMgr = $('screen-teacher-manager');
                if (scrMgr && !scrMgr.classList.contains('hidden')) {
                    const currentLesson = window.session.currentLesson;
                    teacherMgr.currentWords = currentLesson ? window.db.words.filter(w => w.lesson === currentLesson) : window.db.words;
                    teacherMgr.renderList();
                }
            }
            if (window.session.user?.role === 'student') {
                const scrStudy = $('screen-student-study');
                if (scrStudy && !scrStudy.classList.contains('hidden')) {
                    const lesson = window.session.currentLesson; if (!lesson) return;
                    const wordsForLesson = window.db.words.filter(w => w.lesson === lesson);
                    const currentId = window.session.studyList[window.session.currentIndex]?.id;
                    window.session.studyList = [...wordsForLesson];
                    let newIndex = 0; if (currentId) { const idx = wordsForLesson.findIndex(w => w.id === currentId); if (idx !== -1) newIndex = idx; }
                    window.session.currentIndex = newIndex; studentStudy.render();
                }
            }
        };

        window.teacherStats = {
            allStudents: [],
            init: () => { window.teacherStats.allStudents = window.__progressDocs || []; window.teacherStats.refreshClassOptions(); },
            refreshClassOptions: () => {
                const select = $('teacher-class-select');
                const classes = Array.from(new Set((window.teacherStats.allStudents || []).map(s => s.className || 'Chưa rõ lớp')));
                const current = select.value || '';
                select.innerHTML = '<option value="">(Tất cả)</option>' + classes.map(c => `<option value="${c}">${c}</option>`).join('');
                if (current) select.value = current;
                window.teacherStats.renderStudents();
            },
            loadStudents: () => { window.teacherStats.renderStudents(); },
            confirmResetAll: () => { if(confirm("CẢNH BÁO: Xóa toàn bộ tiến độ của mọi người trên Server?")) window.teacherStats.resetAllProgress(); },
            confirmResetClass: () => { const c = $('teacher-class-select').value; if(!c) return alert("Chọn lớp đã"); if(confirm(`Xóa tiến độ lớp ${c}?`)) window.teacherStats.resetClassProgress(c); },
            resetAllProgress: async () => {
                await dbRef.child('progress_all').remove(); await dbRef.child('progress_detail').remove();
                showToast("Đã Reset Server!");
            },
            resetClassProgress: async (className) => {
                const students = window.teacherStats.allStudents.filter(s => s.className === className);
                for(const s of students) { const e = s.email.replace(/\./g, ','); await dbRef.child('progress_all/'+e).remove(); await dbRef.child('progress_detail/'+e).remove(); }
                showToast(`Đã xóa lớp ${className}`);
            },
            renderStudents: () => {
                const container = $('student-list-container'); container.innerHTML = '';
                const all = window.teacherStats.allStudents || [];
                if (!all.length) return container.innerHTML = '<p class="text-xs text-slate-500 italic">Chưa có dữ liệu.</p>';
                const currentClass = $('teacher-class-select').value;
                const filtered = all.filter(s => !currentClass || (s.className || '') === currentClass);
                const totalWords = window.db.words.length || 1;
                container.innerHTML = filtered.map(s => {
                    const progress = s.progress || {}; const allIds = Object.keys(progress);
                    let mastered = 0; allIds.forEach(id => { if (progress[id].status === 'mastered') mastered++; });
                    return `<div class="bg-slate-800 border border-slate-700 rounded-xl p-4"><div class="flex justify-between mb-1"><h4 class="font-bold">${s.name || s.email}</h4><span class="text-xs text-slate-400">${s.email}</span></div><div class="text-xs text-slate-500 mb-2">Lớp: <span class="text-slate-300">${s.className || 'Chưa rõ'}</span></div><div class="w-full bg-slate-700 h-2 rounded-full mb-2"><div class="bg-green-500 h-2 rounded-full" style="width: ${Math.round((mastered/totalWords)*100)}%;"></div></div><div class="text-xs text-slate-400">Đã thuộc: <span class="text-green-400 font-bold">${mastered}/${totalWords}</span></div></div>`;
                }).join('');
            }
        };
        window.handleProgressUpdate = (docs) => { window.teacherStats.allStudents = docs || []; if ($('screen-teacher-progress').classList.contains('hidden') === false) window.teacherStats.refreshClassOptions(); };

        window.app = app; window.geminiService = geminiService; window.teacherMgr = teacherMgr; window.studentStudy = studentStudy; window.dataMgr = dataMgr;
        window.onload = app.init;
    </script>
</body>
</html>
